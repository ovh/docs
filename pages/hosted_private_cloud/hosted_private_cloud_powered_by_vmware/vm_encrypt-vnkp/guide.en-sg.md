---
title: Enabling virtual machine encryption with vSphere Native Key Provider
excerpt: Find out how to implement virtual machine encryption with vSphere Native Key Provider
updated: 2023-01-26
---

## Objective

The aim of this guide is to explain the implementation details of **vSphere Native Key Provider** and then perform a virtual machine encryption in the OVHcloud **VMware on OVHcloud** solution.

**Find out how to implement virtual machine encryption using vSphere Native Key Provider.**

> [!warning]
> OVHcloud provides services for which you are responsible, with regard to their configuration and management. It is therefore your responsibility to ensure that they work properly.
>
> This guide is designed to assist you as much as possible with common tasks. Nevertheless, we recommend contacting a specialist provider if you experience any difficulties or doubts when it comes to managing, using or setting up a service on a server.
>

## Requirements

- a [VMware on OVHcloud solution](https://www.ovhcloud.com/en-sg/enterprise/products/hosted-private-cloud/)
- You must be logged in to your [OVHcloud Control Panel](https://ca.ovh.com/auth/?action=gotomanager&from=https://www.ovh.com/sg/&ovhSubsidiary=sg).
- access to the vSphere management interface
- you must have vSphere version and hosts version 7.0 Update 2 minimum.
- to date, the replication solution **Zerto** is not compatible with encryption. Encrypted VMs cannot therefore be replicated.

> [!warning]
>
> Your **VMware on OVHcloud** cluster may not be in version 7.0 Update 2. If so, please contact support to upgrade your infrastructure.
>

## Presentation

**vSphere Native Key provider** allows you to encrypt virtual machines, enable vTPM in virtual machines, or enable data-at-rest encryption on vSAN, without the need for an external **KMS** (*Key Management Server*).

You can export the **vSphere Native Key provider** key and import it again on another cluster.

In detail, when encrypting a virtual machine, the ESXi host generates a **DEK** key, this key will be used to encrypt the virtual machine's files and therefore its data. The **DEK** key is encrypted using the key generated by **vSphere Native Key provider**. This encrypted DEK is stored with the virtual machine. You can find more details on **VMware** encryption by referring to the official documentation in the [Go further](#gofurther) section of this guide.

## Instructions

### Authorising a user to administer encryption on a Hosted Private Cloud cluster powered by VMware 

Log in to the [OVHcloud Control Panel](https://ca.ovh.com/auth/?action=gotomanager&from=https://www.ovh.com/sg/&ovhSubsidiary=sg), click on `Hosted Private Cloud`{.action} and choose your cluster. Go to `Users`{.action} and click the `...`{.action}

![00 add right from manager 01](images/00-add-right-from-manager01.png){.thumbnail}

Click `Edit`{.action}.

![00 add right from manager 02](images/00-add-right-from-manager02.png){.thumbnail}

Enable `Encryption Management`{.action} and click `Confirm`{.action}.

![00 add right from manager 03](images/00-add-right-from-manager03.png){.thumbnail}

Wait until the change window disappears.

![00 add right from manager 04](images/00-add-right-from-manager04.png){.thumbnail}

Encryption management rights have been changed, as can be seen in the `Encryption management` column.

![00 add right from manager 05](images/00-add-right-from-manager05.png){.thumbnail}

### Creating a vSphere Native Key Provider

We will create the encryption key **vSphere Native Key Provider**. This key can be used to encrypt files on a virtual machine. If you want to add a virtual device **vTPM**, it is mandatory to encrypt the VM.

Log in to the **vSphere** interface. If you need help with this, please refer to our guide on Accessing the vSphere interface (/pages/hosted_private_cloud/hosted_private_cloud_powered_by_vmware/vsphere_interface_connexion).

Click on the root of the `cluster`{.action} in the top left-hand corner, then click on the `Configure`{.action} tab and choose `Key Providers`{.action}.

![01 Create KEY 01](images/01-create-key01.png){.thumbnail}

Click the `ADD`{.action} button and choose `Add Native Key Provider`{.action} from the menu.

![01 Create KEY 02](images/01-create-key02.png){.thumbnail}

Type a name in `Name`.

> [!warning]
>
> If your Private Cloud solution is older than **Premier VMware on OVHcloud**, untick the `Use key provider only with TPM protected ESXi hosts (recommended)` box.
>

Click `ADD KEY PROVIDER`{.action}.

![01 Create KEY 03](images/01-create-key03.png){.thumbnail}

Click the `BACK-UP`{.action} button on the left to back up the key outside the cluster.

![01 Create KEY 04](images/01-create-key04.png){.thumbnail}

Select the checkbox on the left to password protect the backup.

![01 Create KEY 05](images/01-create-key05.png){.thumbnail}

Type a `password` and `confirm it`. Then select the `I have saved the password in a secure place`{.action} box and click `BACK UP KEY PROVIDER`{.action}.

![01 Create KEY 06](images/01-create-key06.png){.thumbnail}

The key can now be used to encrypt virtual machines.

![01 Create KEY 07](images/01-create-key07.png){.thumbnail}

### Encrypting of a virtual machine

We will encrypt a virtual machine and its data. 

> [!warning]
> Encryption of a virtual machine can only be performed when the virtual machine is turned off.
>

Right-click on the `virtual machine`{.action} and from the `VM Policies`{.action} menu choose `Edit VM Storage Policies`{.action}.

![02 encrypt VM 01](images/02-encrypt-vm01.png){.thumbnail}

From the `VM Storage Policies` drop-down menu, choose `VM Encryption Policy`{.action} and click `OK`{.action}.

![02 encrypt VM 02](images/02-encrypt-vm02.png){.thumbnail}

In the virtual machine properties, click the `Summary`{.action} tab. You will see a `padlock` followed by the text `Encrypted with a native key provider` indicating that the VM is encrypted. 

![02 encrypt VM 03](images/02-encrypt-vm03.png){.thumbnail} 

### Migrating an existing encryption solution to vSphere Native Key provider

Some OVHcloud customers use an encryption solution with external KMS keys. Encryption can be migrated to **vSphere Native Key Provider**.

Follow the instructions below to migrate an encrypted virtual machine with a key generated by an external KMS named **cluster** to a vSphere Native Key Provider key named **MY-NKP**.

In the **vSphere** console for your cluster, click on the `cluster root`{.action} in the top left-hand corner.<br>
Go to the top in the `Configure`{.action} tab.<br>
Click `Key Providers`{.action} in the vertical bar, go to the `vSphere Native Key provider`{.action} key and click `SET AS DEFAULT`{.action}.

![03 migrate-from-kms-to-vnkp 01](images/03-migrate-from-kms-to-vnkp01.png){.thumbnail}

Confirm your choice by clicking `SET AS DEFAULT`{.action}.

![03 migrate-from-kms-to-vnkp 02](images/03-migrate-from-kms-to-vnkp02.png){.thumbnail}

The **vSphere Native Key Provider** key is then set by default.

![03 migrate-from-kms-to-vnkp 03](images/03-migrate-from-kms-to-vnkp03.png){.thumbnail}

Click the `virtual machine`{.action} and go to `Summary`{.action} tab. This virtual machine uses the `standard key provider`. We will change the encryption of this virtual machine.

![03 migrate-from-kms-to-vnkp 04](images/03-migrate-from-kms-to-vnkp04.png){.thumbnail}

In the **vSphere** client, right-click on the `virtual machine`{.action} that needs to be encrypted again. In the `VM Policies`{.action} menu entry, choose `Re-encrypt`{.action}.

> [!primary]
> The operation related to the new encryption can be done with the virtual machine turned on because only the **DEK** key is encrypted again.
>

![03 migrate-from-kms-to-vnkp 05](images/03-migrate-from-kms-to-vnkp05.png){.thumbnail}

The new encryption takes a few milliseconds because the operation performed is only a renewal of the encryption of the **DEK** key. This key is now encrypted using the new **vSphere Native Key Provider** key.

![03 migrate-from-kms-to-vnkp 06](images/03-migrate-from-kms-to-vnkp06.png){.thumbnail}

Click the `virtual machine`{.action} on which the encryption has been changed and go to the `Summary`{.action} tab. You can see that encryption uses a native key provider next to the padlock.

![03 migrate-from-kms-to-vnkp 07](images/03-migrate-from-kms-to-vnkp07.png){.thumbnail}

### Encrypting a Datastore of a vSAN cluster

You can encrypt the Datastore of a vSAN cluster instead of the virtual machines.

Through your vSphere interface, go to your `vSAN cluster`{.action} on the right, select the `Configure`{.action} tab, scroll to **Data Services** and click `EDIT`{.action}.

![Activate vSAN data at rest encryption 01](images/04-activate-vsan-data-at-rest-encryption-01.png)

Enable `Data-At-Rest encryption`{.action}, check `Wipe residual Data`{.action}, choose your `Key Provider`{.action} and click `APPLY`{.action}.

> [!primary]
> A warning will inform you that a performance problem may occur when you enable these settings. Please ignore it.
>

![Activate vSAN data at rest encryption 02](images/04-activate-vsan-data-at-rest-encryption-02.png)

Go back to **Data Services** and you will see that **Data encryption at rest** is enabled with your key.

![Activate vSAN data at rest encryption 03](images/04-activate-vsan-data-at-rest-encryption-03.png)

## Go further <a name="gofurther"></a>

[VMware vSphere Native Key Provider Overview](https://core.vmware.com/native-key-provider)

[VMware documentation of the encryption process on vSphere](https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.security.doc/GUID-4A8FA061-0F20-4338-914A-2B7A57051495.html#GUID-4A8FA061-0F20-4338-914A-2B7A57051495)

[VMware vSphere Native Key Provider documentation](https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.security.doc/GUID-54B9FBA2-FDB1-400B-A6AE-81BF3AC9DF97.html#GUID-54B9FBA2-FDB1-400B-A6AE-81BF3AC9DF97)

Join our community of users on <https://community.ovh.com/en/>.
